stream
    |from()
        .database('freshservice')
        .measurement('conntrak')
    |groupBy('region', 'k8s_cluster_name', 'node_name')
    |window()
        .period(1m)
        .every(1m)
    |sum('insert_failed')
        .as('failed_inserts')
    |alert()
        .message('[ {{ .Time }} ] [ {{ index .Tags "region" }} ] [ {{ index .Tags "k8s_cluster_name" }} ] [ {{ index .Tags "node_name" }} ] [ Conntrack Failed Inserts ] - {{ index .Fields "failed_inserts" }} {{ .Level }}')
        .crit(lambda: "failed_inserts" > 0)
        .critReset(lambda: "failed_inserts" == 0)
        .stateChangesOnly()
        .topic('freshservice')
