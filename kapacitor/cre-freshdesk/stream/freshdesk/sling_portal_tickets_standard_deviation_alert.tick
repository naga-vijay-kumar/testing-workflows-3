stream
  |from()
    .database('cre-freshdesk')
    .measurement('cre_cf_sherlock_incoming_helpkit_trends_total')
  |where(lambda: "source" == 'portal' AND "account_id" == '686961')
  |window()
    .period(5m)
    .every(5m)
  |eval(lambda: abs(sigma("counter")))
    .as('sigma')
    .keep()
  |stateDuration(lambda: "sigma" > 3)
    .unit(1m)
  |alert()
    .message('[ {{ .Time }} ] [sling_portal_tickets_standard_deviation_alert] [ There is a deviation greater than 3 sigma in the number of portal tickets/notes received. ] [ Current deviation ]  {{ index .Fields "sigma" }} {{ .Level }}')
    .warn(lambda: "state_duration" >= 10 AND ((hour("time") > 12 OR (hour("time") == 12 AND minute("time") >= 10)) OR ((hour("time") == 5 AND minute("time") <= 15) OR (hour("time") < 5))))
    .warnReset(lambda: "state_duration" == 0)
    .stateChangesOnly()
    .topic('cre-freshdesk')